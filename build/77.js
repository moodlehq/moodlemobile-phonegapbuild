webpackJsonp([77],{1766:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),n.d(t,"AddonModForumNewDiscussionPageModule",function(){return d});var i=n(0),o=n(3),s=n(2),r=n(16),a=n(15),u=n(1882),c=this&&this.__decorate||function(e,t,n,i){var o,s=arguments.length,r=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,n,i);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(r=(s<3?o(r):s>3?o(t,n,r):o(t,n))||r);return s>3&&r&&Object.defineProperty(t,n,r),r},d=function(){function e(){}return e=c([Object(i.I)({declarations:[u.a],imports:[r.a,a.a,o.l.forChild(u.a),s.b.forChild()]})],e)}()},1882:function(e,t,n){"use strict";n.d(t,"a",function(){return O});var i=n(0),o=n(19),s=n(3),r=n(2),a=n(12),u=n(53),c=n(4),d=n(52),l=n(9),f=n(8),h=n(7),m=n(59),p=n(127),g=n(894),v=n(113),I=n(141),b=n(186),D=n(187),w=this&&this.__decorate||function(e,t,n,i){var o,s=arguments.length,r=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,n,i);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(r=(s<3?o(r):s>3?o(t,n,r):o(t,n))||r);return s>3&&r&&Object.defineProperty(t,n,r),r},P=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},y=this&&this.__param||function(e,t){return function(n,i){t(n,i,e)}},O=function(){function e(e,t,n,i,s,r,a,u,c,d,l,f,h,m,p,g){this.navCtrl=t,this.translate=n,this.domUtils=i,this.eventsProvider=s,this.groupsProvider=r,this.sitesProvider=a,this.syncProvider=u,this.uploaderProvider=c,this.textUtils=d,this.utils=l,this.forumProvider=f,this.forumOffline=h,this.forumSync=m,this.forumHelper=p,this.svComponent=g,this.component=v.a.COMPONENT,this.messageControl=new o.b,this.groupsLoaded=!1,this.showGroups=!1,this.hasOffline=!1,this.canCreateAttachments=!0,this.canPin=!1,this.showForm=!1,this.groups=[],this.newDiscussion={subject:"",message:null,groupId:0,subscribe:!0,pin:!1,files:[]},this.isDestroyed=!1,this.courseId=e.get("courseId"),this.cmId=e.get("cmId"),this.forumId=e.get("forumId"),this.timeCreated=e.get("timeCreated")}return e.prototype.ngOnInit=function(){var e=this;this.fetchDiscussionData().finally(function(){e.groupsLoaded=!0})},e.prototype.ionViewDidEnter=function(){var e=this;this.syncObserver=this.eventsProvider.on(D.a.AUTO_SYNCED,function(t){t.forumId==e.forumId&&t.userId==e.sitesProvider.getCurrentSiteUserId()&&(e.domUtils.showAlertTranslated("core.notice","core.contenteditingsynced"),e.returnToDiscussions())},this.sitesProvider.getCurrentSiteId()),this.eventsProvider.trigger(v.a.VIEW_DISCUSSION_EVENT,{forumId:this.forumId,discussion:-this.timeCreated},this.sitesProvider.getCurrentSiteId())},e.prototype.fetchDiscussionData=function(e){var t=this;return this.groupsProvider.getActivityGroupMode(this.cmId).then(function(n){var i=[];return n===u.a.SEPARATEGROUPS||n===u.a.VISIBLEGROUPS?i.push(t.groupsProvider.getActivityAllowedGroups(t.cmId).then(function(e){return(n===u.a.VISIBLEGROUPS?t.validateVisibleGroups(e):t.addAllParticipantsOption(e,!0)).then(function(e){if(!(e.length>0)){var i=n===u.a.SEPARATEGROUPS?"addon.mod_forum.cannotadddiscussionall":"addon.mod_forum.cannotadddiscussion";return Promise.reject(t.translate.instant(i))}t.groups=e,t.newDiscussion.groupId=t.newDiscussion.groupId||e[0].id,t.showGroups=!0})})):(t.showGroups=!1,i.push(t.forumProvider.canAddDiscussionToAll(t.forumId).then(function(e){t.canPin=!!e.canpindiscussions,t.canCreateAttachments=!!e.cancreateattachment}).catch(function(){}))),i.push(t.forumProvider.getForum(t.courseId,t.cmId).then(function(e){t.forum=e})),t.timeCreated&&!e&&(t.syncId=t.forumSync.getForumSyncId(t.forumId),i.push(t.forumSync.waitForSync(t.syncId).then(function(){return t.isDestroyed||t.syncProvider.blockOperation(v.a.COMPONENT,t.syncId),t.forumOffline.getNewDiscussion(t.forumId,t.timeCreated).then(function(e){if(t.hasOffline=!0,e.options=e.options||{},t.newDiscussion.groupId=e.groupid?e.groupid:t.newDiscussion.groupId,t.newDiscussion.subject=e.subject,t.newDiscussion.message=e.message,t.newDiscussion.subscribe=e.options.discussionsubscribe,t.newDiscussion.pin=e.options.discussionpinned,t.messageControl.setValue(e.message),e.options.attachmentsid&&e.options.attachmentsid.offline)return t.forumHelper.getNewDiscussionStoredFiles(t.forumId,t.timeCreated).then(function(e){t.newDiscussion.files=e})})}))),Promise.all(i)}).then(function(){t.originalData||(t.originalData={subject:t.newDiscussion.subject,message:t.newDiscussion.message,files:t.newDiscussion.files.slice()}),t.showForm=!0}).catch(function(e){t.domUtils.showErrorModalDefault(e,"addon.mod_forum.errorgetgroups",!0),t.showForm=!1})},e.prototype.validateVisibleGroups=function(e){var t=this;return this.forumProvider.canAddDiscussionToAll(this.forumId).catch(function(){return{status:!1,canpindiscussions:!1,cancreateattachment:!0}}).then(function(n){if(t.canPin=!!n.canpindiscussions,t.canCreateAttachments=!!n.cancreateattachment,n.status)return t.addAllParticipantsOption(e,!1);var i=[],o=[];return e.forEach(function(e){i.push(t.forumProvider.canAddDiscussion(t.forumId,e.id).catch(function(){return{status:!0}}).then(function(t){t.status&&o.push(e)}))}),Promise.all(i).then(function(){return o})})},e.prototype.filterGroups=function(e,t){var n=[],i=t.map(function(e){return e.id});return e.forEach(function(e){i.indexOf(e.id)>-1&&n.push(e)}),n},e.prototype.addAllParticipantsOption=function(e,t){var n=this;if(!this.forumProvider.isAllParticipantsFixed())return Promise.resolve(e);return(t?this.forumProvider.canAddDiscussionToAll(this.forumId).then(function(e){return n.canPin=!!e.canpindiscussions,n.canCreateAttachments=!!e.cancreateattachment,e.status}).catch(function(){return!1}):Promise.resolve(!0)).then(function(t){return t&&e.unshift({courseid:n.courseId,id:-1,name:n.translate.instant("core.allparticipants")}),e})},e.prototype.refreshGroups=function(e){var t=this,n=[this.groupsProvider.invalidateActivityGroupMode(this.cmId),this.groupsProvider.invalidateActivityAllowedGroups(this.cmId),this.forumProvider.invalidateCanAddDiscussion(this.forumId)];Promise.all(n).finally(function(){t.fetchDiscussionData(!0).finally(function(){e.complete()})})},e.prototype.returnToDiscussions=function(e){this.eventsProvider.trigger(v.a.NEW_DISCUSSION_EVENT,{forumId:this.forumId,cmId:this.cmId,discussionId:e},this.sitesProvider.getCurrentSiteId()),this.uploaderProvider.clearTmpFiles(this.newDiscussion.files),this.svComponent&&this.svComponent.isOn()?(this.hasOffline=!1,this.newDiscussion.subject="",this.newDiscussion.message=null,this.newDiscussion.files=[],this.messageEditor.clearText(),this.originalData=this.utils.clone(this.newDiscussion),this.eventsProvider.trigger(v.a.VIEW_DISCUSSION_EVENT,{forumId:this.forumId,discussion:0},this.sitesProvider.getCurrentSiteId())):(this.originalData=null,this.navCtrl.pop())},e.prototype.onMessageChange=function(e){this.newDiscussion.message=e},e.prototype.add=function(){var e=this,t=this.forum.name,n=this.newDiscussion.subject,i=this.newDiscussion.message,o=this.newDiscussion.pin,s=this.newDiscussion.groupId,r=this.newDiscussion.files,a=this.timeCreated||Date.now(),u={discussionsubscribe:!!this.newDiscussion.subscribe},c=!1;if(n)if(i){var d=this.domUtils.showModalLoading("core.sending",!0);this.domUtils.isRichTextEditorEnabled().then(function(t){if(t||(i=e.textUtils.formatHtmlLines(i)),r.length)return e.forumHelper.uploadOrStoreNewDiscussionFiles(e.forumId,a,r,!1).catch(function(){return c=!0,e.forumHelper.uploadOrStoreNewDiscussionFiles(e.forumId,a,r,!0)})}).then(function(d){return d&&(u.attachmentsid=d),o&&(u.discussionpinned=!0),c?e.forumOffline.addNewDiscussion(e.forumId,t,e.courseId,n,i,u,s,a).then(function(){}):e.forumProvider.addNewDiscussion(e.forumId,t,e.courseId,n,i,u,s,void 0,a,!r.length)}).then(function(t){t&&e.forumHelper.deleteNewDiscussionStoredFiles(e.forumId,a),e.returnToDiscussions(t)}).catch(function(t){e.domUtils.showErrorModalDefault(t,"addon.mod_forum.cannotcreatediscussion",!0)}).finally(function(){d.dismiss()})}else this.domUtils.showErrorModal("addon.mod_forum.erroremptymessage",!0);else this.domUtils.showErrorModal("addon.mod_forum.erroremptysubject",!0)},e.prototype.discard=function(){var e=this;this.domUtils.showConfirm(this.translate.instant("core.areyousure")).then(function(){var t=[];return t.push(e.forumOffline.deleteNewDiscussion(e.forumId,e.timeCreated)),t.push(e.forumHelper.deleteNewDiscussionStoredFiles(e.forumId,e.timeCreated).catch(function(){})),Promise.all(t).then(function(){e.returnToDiscussions()})}).catch(function(){})},e.prototype.ionViewCanLeave=function(){var e=this;return(this.forumHelper.hasPostDataChanged(this.newDiscussion,this.originalData)?this.domUtils.showConfirm(this.translate.instant("core.confirmcanceledit")):Promise.resolve()).then(function(){e.uploaderProvider.clearTmpFiles(e.newDiscussion.files)})},e.prototype.ionViewWillLeave=function(){this.syncObserver&&this.syncObserver.off()},e.prototype.ngOnDestroy=function(){this.syncId&&this.syncProvider.unblockOperation(v.a.COMPONENT,this.syncId),this.isDestroyed=!0},w([Object(i._9)(g.a),P("design:type",g.a)],e.prototype,"messageEditor",void 0),e=w([Object(i.m)({selector:"page-addon-mod-forum-new-discussion",template:'<ion-header>\n    <ion-navbar>\n        <ion-title>{{ \'addon.mod_forum.addanewdiscussion\' | translate }}</ion-title>\n        <ion-buttons end>\n            \x3c!-- The context menu will be added in here. --\x3e\n        </ion-buttons>\n    </ion-navbar>\n</ion-header>\n<ion-content>\n    <ion-refresher [enabled]="groupsLoaded" (ionRefresh)="refreshGroups($event)">\n        <ion-refresher-content pullingText="{{ \'core.pulltorefresh\' | translate }}"></ion-refresher-content>\n    </ion-refresher>\n\n    <core-loading [hideUntil]="groupsLoaded">\n        <ion-list *ngIf="showForm">\n            <ion-item>\n                <ion-label stacked>{{ \'addon.mod_forum.subject\' | translate }}</ion-label>\n                <ion-input type="text" [placeholder]="\'addon.mod_forum.subject\' | translate" [(ngModel)]="newDiscussion.subject"></ion-input>\n            </ion-item>\n            <ion-item>\n                <ion-label stacked>{{ \'addon.mod_forum.message\' | translate }}</ion-label>\n                <core-rich-text-editor item-content [control]="messageControl" (contentChanged)="onMessageChange($event)" [placeholder]="\'addon.mod_forum.message\' | translate" name="addon_mod_forum_new_discussion" [component]="component" [componentId]="forum.cmid"></core-rich-text-editor>\n            </ion-item>\n            <ion-item *ngIf="showGroups">\n                <ion-label id="addon-mod-forum-groupslabel">{{ \'addon.mod_forum.group\' | translate }}</ion-label>\n                <ion-select [(ngModel)]="newDiscussion.groupId" aria-labelledby="addon-mod-forum-groupslabel" interface="popover">\n                    <ion-option *ngFor="let group of groups" [value]="group.id">{{ group.name }}</ion-option>\n                </ion-select>\n            </ion-item>\n            <ion-item>\n                <ion-label>{{ \'addon.mod_forum.discussionsubscription\' | translate }}</ion-label>\n                <ion-toggle [(ngModel)]="newDiscussion.subscribe"></ion-toggle>\n            </ion-item>\n            <ion-item *ngIf="canPin">\n                <ion-label>{{ \'addon.mod_forum.discussionpinned\' | translate }}</ion-label>\n                <ion-toggle [(ngModel)]="newDiscussion.pin"></ion-toggle>\n            </ion-item>\n            <core-attachments *ngIf="canCreateAttachments && forum && forum.maxattachments > 0" [files]="newDiscussion.files" [maxSize]="forum.maxbytes" [maxSubmissions]="forum.maxattachments" [component]="component" [componentId]="forum.cmid" [allowOffline]="true"></core-attachments>\n            <ion-item>\n                <ion-row>\n                    <ion-col>\n                        <button ion-button block (click)="add()" [disabled]="newDiscussion.subject == \'\' || newDiscussion.message == null">{{ \'addon.mod_forum.posttoforum\' | translate }}</button>\n                    </ion-col>\n                    <ion-col *ngIf="hasOffline">\n                        <button ion-button block color="light" (click)="discard()">{{ \'core.discard\' | translate }}</button>\n                    </ion-col>\n                </ion-row>\n            </ion-item>\n        </ion-list>\n    </core-loading>\n</ion-content>\n'}),y(15,Object(i.N)()),P("design:paramtypes",[s.r,s.q,r.c,l.a,a.a,u.a,c.a,d.a,m.a,f.a,h.a,v.a,I.a,D.a,b.a,p.a])],e)}()}});